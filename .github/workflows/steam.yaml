
on:
  push: ~

jobs:
  install:
    runs-on: windows-2022
    steps:
      - name: Install winget
        shell: powershell
        run: |
          Import-Module Appx
          $WinGetVer='1.8.1911'
          $WinGetLicenseFile='76fba573f02545629706ab99170237bc_License1.xml'

          # https://stackoverflow.com/questions/28682642/powershell-why-is-using-invoke-webrequest-much-slower-than-a-browser-download#
          $ProgressPreference = 'SilentlyContinue'

          # Download and install Microsoft.UI.Xaml
          Invoke-WebRequest -Uri https://github.com/microsoft/microsoft-ui-xaml/releases/download/v2.8.6/Microsoft.UI.Xaml.2.8.x64.appx -OutFile $env:TEMP\Microsoft.UI.Xaml.appx
          Add-AppxPackage -Path $env:TEMP\Microsoft.UI.Xaml.appx

          # Download and install Microsoft.DesktopAppInstaller.WinGet
          Invoke-WebRequest -Uri "https://github.com/microsoft/winget-cli/releases/download/v$WinGetVer/Microsoft.DesktopAppInstaller_8wekyb3d8bbwe.msixbundle" -OutFile $env:TEMP\Microsoft.DesktopAppInstaller.WinGet.appx
          Invoke-WebRequest -Uri "https://github.com/microsoft/winget-cli/releases/download/v$WinGetVer/$WinGetLicenseFile" -OutFile $env:TEMP\license.xml
          Add-AppxProvisionedPackage -Online -PackagePath $env:TEMP\Microsoft.DesktopAppInstaller.WinGet.appx -LicensePath $env:TEMP\license.xml

      - name: Install
        run: |
          $url = 'https://cdn.akamai.steamstatic.com/client/installer/SteamSetup.exe'
          Invoke-RestMethod -Uri $url -OutFile SteamSetup.exe
          .\SteamSetup.exe /S /D=C:\Steam
      - name: Login
        run: |
          C:\Steam\steam.exe -silent -forceservice -login ${env:STEAM_USERNAME} ${env:STEAM_PASSWORD}
        env:
          STEAM_USERNAME: ${{ secrets.STEAM_USERNAME }}
          STEAM_PASSWORD: ${{ secrets.STEAM_PASSWORD }}

      - name: Checkout
        uses: actions/checkout@v4

      - name: Test logged in
        run: .\tools\steam-check.exe

      - name: Archive steam logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Steam logs
          path: |
            C:\Steam\logs
            !C:\Steam\logs\bootstrap_log.txt

